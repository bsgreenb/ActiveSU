{% extends 'backbone/base.html' %}

{% block css-link %}
<link href="/static/css/wall.css" type="text/css" title="default" rel="stylesheet" media="screen, projection">

<link href="/static/css/feed.css" type="text/css" title="default" rel="stylesheet" media="screen, projection">

<link href="/static/css/datepicker.css" type="text/css" title="default" rel="stylesheet" media="screen, projection">
{% endblock %}

{% block js %}
<script src="/static/js/plugin/bootstrap-datepicker.js"></script>
<script src="/static/js/plugin/events.js"></script>

<script>
    $(document).ready(function() {

        {% if event_form_with_error %}
            $('#event-tab').click(); //from event post form.
        {% endif %}

        {% if not user.is_authenticated %}
        $('.row input, .row select, .row button, .row select, .row textarea').addClass('disabled').attr('disabled', '');
        $('#post-message').attr('placeholder', 'login to post a message...');
        $('#post-what').attr('placeholder', 'login to post an event...');
        $('.comment').attr('placeholder', 'login to post a comment...');

        {% endif %}
        
        $('a.close').live('click',function() {
            $(this).parent('div.alert').remove();
        });


        /* Update datepicker plugin so that MM/DD/YYYY format is used. */
        $.extend($.fn.datepicker.defaults, {
            parse: function (string) {
                var matches;
                if ((matches = string.match(/^(\d{2,2})\/(\d{2,2})\/(\d{4,4})$/))) {
                    return new Date(matches[3], matches[1] - 1, matches[2]);
                } else {
                    return null;
                }
            },
            format: function (date) {
                var
                        month = (date.getMonth() + 1).toString(),
                        dom = date.getDate().toString();
                if (month.length === 1) {
                    month = "0" + month;
                }
                if (dom.length === 1) {
                    dom = "0" + dom;
                }
                return month + "/" + dom + "/" + date.getFullYear();
            }
        });

        var ENTER_KEY_CODE = 13;

        $('#post-message').keypress(function(event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == ENTER_KEY_CODE){
                $('#post-message-form').submit();
            }
        });

        $('.input-large.comment').keypress(function(event) {
            $('.comment-error-message').hide();
            var target_divs = $('.' + $(this).attr('post-id'));
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == ENTER_KEY_CODE)
            {
                thisInput = $(this); //store for showing comment error message
                $.ajax({
                    url: 'submit_comment',
                    type: 'POST',
                    data: 'post=' + thisInput.attr('post-id') + '&content=' + $(this).val() + '&csrfmiddlewaretoken={{ csrf_token }}',
                    complete: function (data, status)
                    {
                        data = $.parseJSON(data.responseText);
                        
                        if ((status == 'success') && data.status == 'OK' && data.length != 0)
                        {
                            target_divs.before('<div>' + data.comment + '</div>');
                            thisInput.val('');
                        }
                        else
                        {
                            thisInput.next('.comment-error-message').show();
                        }
                    }
                });
            }
        });
});
</script>
{% endblock %}


{% block css %}
.datepicker .fg{
font-size: 13px;
}

.datepicker .dow{
font-size: 12px;
}

#tab-posts{
margin: 0
}

{% endblock %}


{% block content %}
<div class="row">
<div class="span8">
<div class="content">
<div class="head">
    <a href="{{activity_page.url_code}}" class="name">{{activity_page.name}}</a>
    <span class="active-info">| {{activity_page.post_set.all|length}} posts</span>
</div>

<div class="tabbable">
<ul class="nav nav-tabs">
    <li class="active">
        <a href="#1" data-toggle="tab">Message</a>
    </li>
    <li>
        <a href="#2" data-toggle="tab" id="event-tab">Event</a>
    </li>
</ul>


<div class="tab-content">

<div class="tab-pane active" id="1">
    <form method="POST" class="form-inline" action="{% url post_message %}" id="post-message-form">
        <input type="hidden" name="activity_page" value="{{activity_page.id}}" />
        {% csrf_token %}
        {% if message_form_with_error %}
        <div class="alert alert-error">
            <a class="close" href="#">x</a>
            <ul>
                {% for field in message_form_with_error %}
                {% if field.errors %}
                <li>{{ field.errors|striptags }}</li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}


        <input class="input-xlarge post-message" placeholder="Write a message..." name="content" id="post-message"/><button class="btn btn-success">Post</button>

    </form>
</div>


<div class="tab-pane" id="2">

    <form class="form-horizontal" method="POST" action="{% url post_event %}">
        <input type="hidden" name="activity_page" value="{{activity_page.id}}" />
        {% csrf_token %}

        {% if event_form_with_error %}
        <div class="alert alert-error">
            <a class="close" href="#">x</a>
            <ul>
                {% for field in event_form_with_error %}
                {% if field.errors %}
                <li>{{field.errors|striptags }}</li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="control-group">
            <label class="control-label">What </label>
            <div class="controls">
                <input class="input-xlarge" type="text" value="" name="title" id="post-what"/>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Where </label>
            <div class="controls">
                <input class="input-xlarge" type="text" value="" name="where"/>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Start </label>
            <div class="controls">
                <input data-datepicker="datepicker" class="input-medium" type="text" value="" name="start_date"/>
                <select class="span2" name="start_time">
                    <option value="0">12:00 am</option>
                    <option value="30">12:30 am</option>
                    <option value="60">1:00 am</option>
                    <option value="90">1:30 am</option>
                    <option value="120">2:00 am</option>
                    <option value="150">2:30 am</option>
                    <option value="180">3:00 am</option>
                    <option value="210">3:30 am</option>
                    <option value="240">4:00 am</option>
                    <option value="270">4:30 am</option>
                    <option value="300">5:00 am</option>
                    <option value="330">5:30 am</option>
                    <option value="360">6:00 am</option>
                    <option value="390">6:30 am</option>
                    <option value="420">7:00 am</option>
                    <option value="450">7:30 am</option>
                    <option value="480">8:00 am</option>
                    <option value="510">8:30 am</option>
                    <option value="540">9:00 am</option>
                    <option value="570">9:30 am</option>
                    <option value="600">10:00 am</option>
                    <option value="630">10:30 am</option>
                    <option value="660">11:00 am</option>
                    <option value="690">11:30 am</option>
                    <option value="720">12:00 pm</option>
                    <option value="750">12:30 pm</option>
                    <option value="780">1:00 pm</option>
                    <option value="810">1:30 pm</option>
                    <option value="840">2:00 pm</option>
                    <option value="870">2:30 pm</option>
                    <option value="900">3:00 pm</option>
                    <option value="930">3:30 pm</option>
                    <option value="960">4:00 pm</option>
                    <option value="990">4:30 pm</option>
                    <option value="1020">5:00 pm</option>
                    <option value="1050">5:30 pm</option>
                    <option value="1080">6:00 pm</option>
                    <option value="1110">6:30 pm</option>
                    <option value="1140">7:00 pm</option>
                    <option value="1170">7:30 pm</option>
                    <option value="1200" selected="selected">8:00 pm</option>
                    <option value="1230">8:30 pm</option>
                    <option value="1260">9:00 pm</option>
                    <option value="1290">9:30 pm</option>
                    <option value="1320">10:00 pm</option>
                    <option value="1350">10:30 pm</option>
                    <option value="1380">11:00 pm</option>
                    <option value="1410">11:30 pm</option>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">End (optional) </label>
            <div class="controls">
                <input data-datepicker="datepicker" class="input-medium" type="text" value="" name="end_date"/>
                <select class="span2" name="end_time">
                    <option value="">Time</option>
                    <option value="0">12:00 am</option>
                    <option value="30">12:30 am</option>
                    <option value="60">1:00 am</option>
                    <option value="90">1:30 am</option>
                    <option value="120">2:00 am</option>
                    <option value="150">2:30 am</option>
                    <option value="180">3:00 am</option>
                    <option value="210">3:30 am</option>
                    <option value="240">4:00 am</option>
                    <option value="270">4:30 am</option>
                    <option value="300">5:00 am</option>
                    <option value="330">5:30 am</option>
                    <option value="360">6:00 am</option>
                    <option value="390">6:30 am</option>
                    <option value="420">7:00 am</option>
                    <option value="450">7:30 am</option>
                    <option value="480">8:00 am</option>
                    <option value="510">8:30 am</option>
                    <option value="540">9:00 am</option>
                    <option value="570">9:30 am</option>
                    <option value="600">10:00 am</option>
                    <option value="630">10:30 am</option>
                    <option value="660">11:00 am</option>
                    <option value="690">11:30 am</option>
                    <option value="720">12:00 pm</option>
                    <option value="750">12:30 pm</option>
                    <option value="780">1:00 pm</option>
                    <option value="810">1:30 pm</option>
                    <option value="840">2:00 pm</option>
                    <option value="870">2:30 pm</option>
                    <option value="900">3:00 pm</option>
                    <option value="930">3:30 pm</option>
                    <option value="960">4:00 pm</option>
                    <option value="990">4:30 pm</option>
                    <option value="1020">5:00 pm</option>
                    <option value="1050">5:30 pm</option>
                    <option value="1080">6:00 pm</option>
                    <option value="1110">6:30 pm</option>
                    <option value="1140">7:00 pm</option>
                    <option value="1170">7:30 pm</option>
                    <option value="1200">8:00 pm</option>
                    <option value="1230">8:30 pm</option>
                    <option value="1260">9:00 pm</option>
                    <option value="1290">9:30 pm</option>
                    <option value="1320">10:00 pm</option>
                    <option value="1350">10:30 pm</option>
                    <option value="1380">11:00 pm</option>
                    <option value="1410">11:30 pm</option>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Description (optional)</label>
            <div class="controls">
                <textarea name="description" class="input-xlarge" rows="2" ></textarea>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label"></label>
            <div class="controls">
                <button class="btn btn-success" type="submit">Create Event</button>
            </div>
        </div>
    </form>
</div>
</div>


</div>


<div class="tabbable">
    <ul class="nav nav-pills" id="tab-posts">
        <li class="active"><a href="#3" data-toggle="tab">Show All Posts</a></li>
        <li><a href="#4" data-toggle="tab">Show Only Events</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane active" id="3">
            <div class="posts">
                {%if not all_posts %}
                There are currently no posts on this page.  You can be the first to add one!
                {%else%}

                {%for post in all_posts %}
                <div class="post">
                    {%if post.text_post.content %}
                        <div><b>{{post.user.username}}: </b>{{post.text_post.content}}<span class="post-end"> | {{post.post_time}}</span></div>
                    {%else%}
                        <div><b>{{post.user.username}}</b></div>
                        <div><i class="icon-calendar"></i>{{post.event_post.title}}</div>

                        <div>When: {{post.event_post.start_datetime}}
                            {% if post.event_post.end_datetime %}
                             - {{post.event_post.end_datetime}}
                            {% endif %}
                        </div>

                        <div>Where: {{post.event_post.where}}</div>
                        <div>{{post.event_post.description}}</div>
                        <div><span class="post-end">Posted at {{post.post_time}}</span></div>
                    {%endif%}
                    <div class="comments">
                        {% if post.comment_set.all %}
                        {%for comment in post.comment_set.all %}
                        <div><b>{{comment.user.username}}: </b>{{comment.content}}<span class="post-end"> | {{comment.comment_time}}</span></div>

                        {%endfor%}
                        {%endif%}

                        <div class="{{post.id}}">
                            <input class="input-large comment" placeholder="Write a comment..." post-id="{{post.id}}"><span class="comment-error-message" style="display:None">ah, please try again.</span>
                        </div>


                    </div>
                </div>
                {%endfor%}
                {%endif%}
            </div>
        </div>

        <div class="tab-pane" id="4">
            <div class="posts">
                {% if not future_events %}
                There are currently no events on this page. You can be the first to add one!
                {% else %}
                {% for event in future_events %}
                    <div class="post">
                        <div><b>{{event.post.user.username}}</b></div>
                        <div><i class="icon-calendar"></i>{{event.title}}</div>

                        <div>When: {{event.start_datetime}}
                        {% if event.end_datetime %}
                            - {{event.end_datetime}}
                        {% endif %}
                        </div>

                        <div>Where: {{event.where}}</div>
                        <div>{{event.description}}</div>
                        <div><span class="post-end">Posted at {{event.post.post_time}}</span></div>


                        <div class="comments">
                            {% if event.post.comment_set.all %}
                            {% for comment in event.post.comment_set.all %}
                            <div><b>{{comment.user.username}}: </b>{{comment.content}}<span class="post-end"> | {{comment.comment_time}}</span></div>
                            {%endfor%}
                            {%endif%}

                            <div class="{{event.post.id}}">
                                <input class="input-large comment" post-id="{{event.post.id}}" placeholder="Write a comment..."><span class="comment-error-message" style="display:None">ah, please try again.</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>


    </div>
</div>
</div>
</div>
<div class="span3">

    {% include 'backbone/feed.html' %}

</div>
</div>
{% endblock %}



